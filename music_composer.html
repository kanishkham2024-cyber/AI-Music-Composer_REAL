<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Music Composer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .controls {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        select, input[type="range"], input[type="number"] {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 1rem;
        }

        .range-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .range-container input[type="range"] {
            flex: 1;
        }

        .range-value {
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
        }

        .generate-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .player {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .player-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .visualizer {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .visualizer h3 {
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5rem;
        }

        .notation {
            background: white;
            border-radius: 15px;
            padding: 20px;
            color: #333;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }

        .chord-progression {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .chord {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .melody-line {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }

        .status {
            text-align: center;
            margin: 20px 0;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .loading {
            color: #ffd93d;
        }

        .success {
            color: #6bcf7f;
        }

        .advanced-controls {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .harmonizer {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .harmonizer h4 {
            margin-bottom: 15px;
            color: #ffd93d;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.9);
            color: #333;
            font-family: 'Courier New', monospace;
            resize: vertical;
            min-height: 80px;
        }

        .download-section {
            text-align: center;
            margin-top: 20px;
        }

        .download-btn {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .player-controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎵 AI Music Composer</h1>
            <p>Generate original music compositions with artificial intelligence</p>
        </div>

        <div class="controls">
            <div class="control-grid">
                <div class="control-group">
                    <label for="genre">Genre</label>
                    <select id="genre">
                        <option value="classical">Classical</option>
                        <option value="jazz">Jazz</option>
                        <option value="rock">Rock</option>
                        <option value="electronic">Electronic</option>
                        <option value="folk">Folk</option>
                        <option value="ambient">Ambient</option>
                        <option value="blues">Blues</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="mood">Mood</label>
                    <select id="mood">
                        <option value="happy">Happy</option>
                        <option value="sad">Sad</option>
                        <option value="energetic">Energetic</option>
                        <option value="calm">Calm</option>
                        <option value="mysterious">Mysterious</option>
                        <option value="dramatic">Dramatic</option>
                        <option value="romantic">Romantic</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="tempo">Tempo (BPM)</label>
                    <div class="range-container">
                        <input type="range" id="tempo" min="60" max="180" value="120">
                        <div class="range-value" id="tempoValue">120</div>
                    </div>
                </div>

                <div class="control-group">
                    <label for="key">Key Signature</label>
                    <select id="key">
                        <option value="C">C Major</option>
                        <option value="G">G Major</option>
                        <option value="D">D Major</option>
                        <option value="A">A Major</option>
                        <option value="E">E Major</option>
                        <option value="F">F Major</option>
                        <option value="Bb">Bb Major</option>
                        <option value="Am">A Minor</option>
                        <option value="Em">E Minor</option>
                        <option value="Dm">D Minor</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="duration">Duration (seconds)</label>
                    <div class="range-container">
                        <input type="range" id="duration" min="15" max="120" value="30">
                        <div class="range-value" id="durationValue">30</div>
                    </div>
                </div>

                <div class="control-group">
                    <label for="complexity">Complexity</label>
                    <div class="range-container">
                        <input type="range" id="complexity" min="1" max="5" value="3">
                        <div class="range-value" id="complexityValue">3</div>
                    </div>
                </div>
            </div>

            <div class="advanced-controls">
                <div class="harmonizer">
                    <h4>🎼 Custom Melody Harmonizer (Optional)</h4>
                    <textarea id="customMelody" placeholder="Enter your melody in note format (e.g., C4 D4 E4 F4 G4) or leave empty for AI-generated melody"></textarea>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="generate-btn" id="generateBtn">🎵 Generate Music</button>
            </div>
        </div>

        <div id="status" class="status"></div>

        <div class="player" id="playerSection" style="display: none;">
            <h3>🎧 Music Player</h3>
            <div class="player-controls">
                <button class="control-btn" id="playBtn">▶ Play</button>
                <button class="control-btn" id="pauseBtn">⏸ Pause</button>
                <button class="control-btn" id="stopBtn">⏹ Stop</button>
            </div>
            
            <div class="download-section">
                <button class="download-btn" id="downloadMidi">📄 Download MIDI</button>
                <button class="download-btn" id="downloadWav">🎵 Download WAV</button>
            </div>
        </div>

        <div class="visualizer" id="visualizer" style="display: none;">
            <h3>🎼 Music Notation & Analysis</h3>
            <div class="notation">
                <div class="chord-progression" id="chordProgression"></div>
                <div class="melody-line" id="melodyLine"></div>
            </div>
        </div>
    </div>

    <script>
        let currentSynths = [];
        let currentSequence = null;
        let generatedMusic = null;
        let isPlaying = false;

        // Music theory data structures
        const scales = {
            'C': ['C', 'D', 'E', 'F', 'G', 'A', 'B'],
            'G': ['G', 'A', 'B', 'C', 'D', 'E', 'F#'],
            'D': ['D', 'E', 'F#', 'G', 'A', 'B', 'C#'],
            'A': ['A', 'B', 'C#', 'D', 'E', 'F#', 'G#'],
            'E': ['E', 'F#', 'G#', 'A', 'B', 'C#', 'D#'],
            'F': ['F', 'G', 'A', 'Bb', 'C', 'D', 'E'],
            'Bb': ['Bb', 'C', 'D', 'Eb', 'F', 'G', 'A'],
            'Am': ['A', 'B', 'C', 'D', 'E', 'F', 'G'],
            'Em': ['E', 'F#', 'G', 'A', 'B', 'C', 'D'],
            'Dm': ['D', 'E', 'F', 'G', 'A', 'Bb', 'C']
        };

        const chordProgressions = {
            classical: ['I', 'vi', 'IV', 'V', 'I'],
            jazz: ['vi', 'ii', 'V', 'I', 'vi'],
            rock: ['I', 'V', 'vi', 'IV'],
            electronic: ['vi', 'IV', 'I', 'V'],
            folk: ['I', 'IV', 'V', 'I'],
            ambient: ['I', 'vi', 'iii', 'IV'],
            blues: ['I', 'I', 'I', 'I', 'IV', 'IV', 'I', 'I', 'V', 'IV', 'I', 'V']
        };

        const moodAdjustments = {
            happy: { octave: 4, velocity: 0.8, harmonies: ['major', 'major7'] },
            sad: { octave: 3, velocity: 0.5, harmonies: ['minor', 'minor7'] },
            energetic: { octave: 5, velocity: 0.9, harmonies: ['major', 'sus4'] },
            calm: { octave: 3, velocity: 0.4, harmonies: ['minor', 'add9'] },
            mysterious: { octave: 3, velocity: 0.6, harmonies: ['diminished', 'minor7b5'] },
            dramatic: { octave: 4, velocity: 0.85, harmonies: ['minor', 'augmented'] },
            romantic: { octave: 4, velocity: 0.6, harmonies: ['major7', 'minor9'] }
        };

        // Initialize event listeners
        document.getElementById('tempo').addEventListener('input', function() {
            document.getElementById('tempoValue').textContent = this.value;
        });

        document.getElementById('duration').addEventListener('input', function() {
            document.getElementById('durationValue').textContent = this.value;
        });

        document.getElementById('complexity').addEventListener('input', function() {
            document.getElementById('complexityValue').textContent = this.value;
        });

        document.getElementById('generateBtn').addEventListener('click', generateMusic);
        document.getElementById('playBtn').addEventListener('click', playMusic);
        document.getElementById('pauseBtn').addEventListener('click', pauseMusic);
        document.getElementById('stopBtn').addEventListener('click', stopMusic);
        document.getElementById('downloadMidi').addEventListener('click', downloadMidi);
        document.getElementById('downloadWav').addEventListener('click', downloadWav);

        async function generateMusic() {
            const generateBtn = document.getElementById('generateBtn');
            const status = document.getElementById('status');
            
            generateBtn.disabled = true;
            status.innerHTML = '<div class="loading">🎵 Composing your music... Please wait</div>';

            try {
                // Get user parameters
                const params = {
                    genre: document.getElementById('genre').value,
                    mood: document.getElementById('mood').value,
                    tempo: parseInt(document.getElementById('tempo').value),
                    key: document.getElementById('key').value,
                    duration: parseInt(document.getElementById('duration').value),
                    complexity: parseInt(document.getElementById('complexity').value),
                    customMelody: document.getElementById('customMelody').value.trim()
                };

                // Generate music composition
                generatedMusic = await composeMusic(params);
                
                // Setup audio synthesis
                await setupAudioSynthesis();
                
                // Show player and visualizer
                document.getElementById('playerSection').style.display = 'block';
                document.getElementById('visualizer').style.display = 'block';
                
                // Update visualizer
                updateVisualizer(generatedMusic);
                
                status.innerHTML = '<div class="success">✨ Music composition completed! Ready to play</div>';

            } catch (error) {
                console.error('Error generating music:', error);
                status.innerHTML = '<div style="color: #ff6b6b;">❌ Error generating music. Please try again.</div>';
            } finally {
                generateBtn.disabled = false;
            }
        }

        async function composeMusic(params) {
            // AI Music Composition Algorithm
            const scale = scales[params.key];
            const progression = chordProgressions[params.genre] || chordProgressions.classical;
            const moodData = moodAdjustments[params.mood];
            
            const composition = {
                metadata: {
                    title: `AI ${params.genre} in ${params.key}`,
                    genre: params.genre,
                    mood: params.mood,
                    tempo: params.tempo,
                    key: params.key,
                    duration: params.duration
                },
                chords: [],
                melody: [],
                bass: [],
                rhythm: []
            };

            // Generate chord progression
            const chordDuration = (params.duration / progression.length);
            progression.forEach((chordNumeral, index) => {
                const chord = generateChord(chordNumeral, scale, moodData, params.complexity);
                composition.chords.push({
                    time: index * chordDuration,
                    duration: chordDuration,
                    notes: chord.notes,
                    name: chord.name
                });
            });

            // Generate melody
            if (params.customMelody) {
                composition.melody = harmonizeCustomMelody(params.customMelody, composition.chords, scale, moodData);
            } else {
                composition.melody = generateMelody(composition.chords, scale, moodData, params);
            }

            // Generate bass line
            composition.bass = generateBassLine(composition.chords, scale, moodData);

            // Generate rhythm pattern
            composition.rhythm = generateRhythm(params.genre, params.duration, params.tempo);

            return composition;
        }

        function generateChord(numeral, scale, moodData, complexity) {
            const romanNumerals = {
                'I': 0, 'ii': 1, 'iii': 2, 'IV': 3, 'V': 4, 'vi': 5, 'vii': 6
            };
            
            const root = romanNumerals[numeral] || 0;
            const rootNote = scale[root];
            const octave = moodData.octave || 4;
            
            let notes = [
                rootNote + octave,
                scale[(root + 2) % 7] + octave,
                scale[(root + 4) % 7] + octave
            ];

            // Add complexity based on mood and settings
            if (complexity > 3) {
                notes.push(scale[(root + 6) % 7] + octave);
            }
            if (complexity === 5) {
                notes.push(scale[(root + 1) % 7] + (octave + 1));
            }

            return {
                notes: notes,
                name: rootNote + (numeral.toLowerCase() === numeral ? 'm' : '')
            };
        }

        function generateMelody(chords, scale, moodData, params) {
            const melody = [];
            const notesPerChord = Math.max(4, Math.floor(params.complexity * 2));
            
            chords.forEach(chord => {
                const chordDuration = chord.duration / notesPerChord;
                
                for (let i = 0; i < notesPerChord; i++) {
                    const noteTime = chord.time + (i * chordDuration);
                    const scaleIndex = Math.floor(Math.random() * scale.length);
                    const note = scale[scaleIndex] + (moodData.octave + 1);
                    
                    melody.push({
                        time: noteTime,
                        duration: chordDuration * 0.8,
                        note: note,
                        velocity: moodData.velocity
                    });
                }
            });

            return melody;
        }

        function harmonizeCustomMelody(customMelody, chords, scale, moodData) {
            const noteStrings = customMelody.split(/\s+/);
            const melody = [];
            const totalDuration = chords.reduce((sum, chord) => sum + chord.duration, 0);
            const noteDuration = totalDuration / noteStrings.length;

            noteStrings.forEach((noteStr, index) => {
                if (noteStr) {
                    melody.push({
                        time: index * noteDuration,
                        duration: noteDuration * 0.8,
                        note: noteStr,
                        velocity: moodData.velocity
                    });
                }
            });

            return melody;
        }

        function generateBassLine(chords, scale, moodData) {
            const bassLine = [];
            
            chords.forEach(chord => {
                bassLine.push({
                    time: chord.time,
                    duration: chord.duration,
                    note: chord.notes[0].replace(/\d/, '') + (moodData.octave - 1),
                    velocity: moodData.velocity * 0.8
                });
            });

            return bassLine;
        }

        function generateRhythm(genre, duration, tempo) {
            const rhythm = [];
            const beatDuration = 60 / tempo;
            const totalBeats = duration / beatDuration;

            const patterns = {
                rock: [1, 0, 1, 0],
                jazz: [1, 0, 0, 1],
                electronic: [1, 0, 1, 1],
                classical: [1, 0, 0, 0],
                folk: [1, 0, 1, 0],
                ambient: [1, 0, 0, 0],
                blues: [1, 0, 0, 1]
            };

            const pattern = patterns[genre] || patterns.rock;
            
            for (let beat = 0; beat < totalBeats; beat++) {
                if (pattern[beat % pattern.length]) {
                    rhythm.push({
                        time: beat * beatDuration,
                        duration: beatDuration * 0.1,
                        velocity: 0.6
                    });
                }
            }

            return rhythm;
        }

        async function setupAudioSynthesis() {
            // Initialize Tone.js
            await Tone.start();
            
            // Clean up previous synths
            currentSynths.forEach(synth => synth.dispose());
            currentSynths = [];

            // Create synths for different parts
            const leadSynth = new Tone.Synth({
                oscillator: { type: "sawtooth" },
                envelope: { attack: 0.1, decay: 0.2, sustain: 0.5, release: 0.8 }
            }).toDestination();

            const chordSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "square" },
                envelope: { attack: 0.2, decay: 0.3, sustain: 0.4, release: 1 }
            }).toDestination();

            const bassSynth = new Tone.MonoSynth({
                oscillator: { type: "triangle" },
                envelope: { attack: 0.1, decay: 0.3, sustain: 0.7, release: 0.5 }
            }).toDestination();

            currentSynths = [leadSynth, chordSynth, bassSynth];

            // Set up transport
            Tone.Transport.bpm.value = parseInt(document.getElementById('tempo').value);
        }

        async function playMusic() {
            if (!generatedMusic || isPlaying) return;

            isPlaying = true;
            document.getElementById('playBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('stopBtn').disabled = false;

            // Schedule all parts
            const [leadSynth, chordSynth, bassSynth] = currentSynths;

            // Schedule melody
            generatedMusic.melody.forEach(note => {
                Tone.Transport.schedule((time) => {
                    leadSynth.triggerAttackRelease(note.note, note.duration, time, note.velocity);
                }, note.time);
            });

            // Schedule chords
            generatedMusic.chords.forEach(chord => {
                Tone.Transport.schedule((time) => {
                    chordSynth.triggerAttackRelease(chord.notes, chord.duration, time, 0.3);
                }, chord.time);
            });

            // Schedule bass
            generatedMusic.bass.forEach(bass => {
                Tone.Transport.schedule((time) => {
                    bassSynth.triggerAttackRelease(bass.note, bass.duration, time, bass.velocity);
                }, bass.time);
            });

            // Start transport
            Tone.Transport.start();

            // Auto-stop after duration
            setTimeout(() => {
                if (isPlaying) stopMusic();
            }, generatedMusic.metadata.duration * 1000);
        }

        function pauseMusic() {
            if (isPlaying) {
                Tone.Transport.pause();
                document.getElementById('playBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = true;
            }
        }

        function stopMusic() {
            Tone.Transport.stop();
            Tone.Transport.cancel();
            isPlaying = false;
            
            document.getElementById('playBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
        }

        function updateVisualizer(music) {
            const chordDiv = document.getElementById('chordProgression');
            const melodyDiv = document.getElementById('melodyLine');

            // Display chord progression
            chordDiv.innerHTML = '';
            music.chords.forEach(chord => {
                const chordElement = document.createElement('div');
                chordElement.className = 'chord';
                chordElement.textContent = chord.name;
                chordDiv.appendChild(chordElement);
            });

            // Display melody information
            const melodyNotes = music.melody.map(note => note.note).slice(0, 20).join(' → ');
            melodyDiv.innerHTML = `
                <strong>Melody Preview:</strong><br>
                ${melodyNotes}${music.melody.length > 20 ? '...' : ''}<br><br>
                <strong>Composition Details:</strong><br>
                Title: ${music.metadata.title}<br>
                Genre: ${music.metadata.genre}<br>
                Mood: ${music.metadata.mood}<br>
                Key: ${music.metadata.key}<br>
                Tempo: ${music.metadata.tempo} BPM<br>
                Duration: ${music.metadata.duration} seconds
            `;
        }

        function downloadMidi() {
            if (!generatedMusic) return;
            
            // Create a simple MIDI-like text format
            let midiContent = `AI Music Composition\n`;
            midiContent += `Title: ${generatedMusic.metadata.title}\n`;
            midiContent += `Tempo: ${generatedMusic.metadata.tempo}\n\n`;
            
            midiContent += `CHORDS:\n`;
            generatedMusic.chords.forEach(chord => {
                midiContent += `${chord.time.toFixed(2)}s: ${chord.name} (${chord.notes.join(', ')})\n`;
            });
            
            midiContent += `\nMELODY:\n`;
            generatedMusic.melody.forEach(note => {
                midiContent += `${note.time.toFixed(2)}s: ${note.note} (${note.duration.toFixed(2)}s)\n`;
            });

            downloadFile(midiContent, `${generatedMusic.metadata.title}.txt`, 'text/plain');
        }

        function downloadWav() {
            if (!generatedMusic) return;
            
            // Create a simple audio data representation
            const audioData = {